---
layout: post
title: "iOS开发连不上服务器问题"
subtitle: ""
author: "DamonFish"
header-style: text
tags:
  - 网络
  - iOS
---

## 问题概述

用户的问题表现是： 连不上服务器。

为了方便说明， 将网络请求类比为打有线电话给一座大楼中的某个座机。

网络请求域名比如"google.com" ->  DNS解析  ->  和目标服务器IP开始通信 

请求拨打号码  ->  到达大楼的总机，帮我们转对应座机 ->  和座机对话

这3步过程中，可能出现的问题

1. 网络断了 （电话线断了）
2. DNS解析失败，没有找到服务器  （总机转座机，找不到座机）
3. 找到了错的服务器（总机转到了错的座机）

>从原理上讲，问题只会出现在这三步, 也就是问题只可能是这几种

针对上述问题，APP端可以实施的方案说明如下。

### 网络断开

正确的提示即可;
网络问题的错误码是系统错误，[URL Loading System error codes](https://developer.apple.com/documentation/foundation/1508628-url_loading_system_error_codes); 
注意和HTTP response status codes以及后台定义的业务错误error code，这三种要区分开。

> 注意： 考虑用户首次进入，没有给网络权限的情况； 比如第三方库的初始化，或者初始配置的获取，在首次获取网络权限后再处理。

### 没找到目标服务器（DNS解析失败）

通常是因为手机本地的DNS解析有问题， 可能是DNS劫持或污染， 导致本地DNS出问题。

常见的解决方案：

指导用户修改本地DNS（类似在网络设置中配置114的DNS地址）来缓解该问题，不一定有效，且需要用户操作。

#### HttpDNS方案

HttpDNS是之前普遍的做法，使用HttpDNS这样的第三方服务直接获取到IP，然后用IP直接请求。 不经过本地DNS来解析获取IP。
目前各大平台推荐的实现方式是使用NSURLProtol拦截请求， 然后修改请求的地址为HttpDNS处理过后的IP地址。
缺点：
NSURLProtol本身实现比较繁琐，多线程问题， 另外还有请求重定向，以及iOS 上的老大难的 SNI 问题。

#### 加密DNS方案

iOS14以后， iOS支持加密DNS。
传统的DNS是UDP连接， 明文传输，安全难有保障。
现在各大厂商陆续提供加密DNS的服务， iOS这边指定一个加密DNS的服务地址（第三方提供），
可以让App内的DNS解析全部走第三方的加密DNS服务器，而不是本地DNS。
这样也类似实现了上面HttpDNS的功能。
缺点是： DSN解析速度会有一定的影响（百毫秒级别），免费的加密DNS服务不保证绝对可用，且有一定的流量限制。

目前个人推荐使用加密DNS方案。

### 找到了错的服务器

其实就是中间人攻击，中间人冒充我们的服务器和我们通信。Charles的实现就是该原理。
错的服务器可能不响应我们的请求， 也可能返回错误的无法处理的response。

解决方案: 公钥验证

我们可以验证服务器的身份。 Https的请求建立后， 服务器会返回公钥证书， 可以通过验证这个公钥证书来验证服务器的身份。

发送HTTPS请求首先要进行SSL/TLS握手，握手过程大致如下：

1. 客户端发起握手请求，携带随机数、支持算法列表等参数。
2. 服务端收到请求，选择合适的算法，下发公钥证书和随机数。
3. 客户端对服务端证书进行校验，并发送随机数信息，该信息使用公钥加密。
4. 服务端通过私钥获取随机数信息。
5. 双方根据以上交互的信息生成session ticket，用作该连接后续数据传输的加密密钥。

公钥验证在第3步。

目前网络请求库都支持公钥验证，即是所谓的Public Key Pinning。

我们在App中内置公钥证书， 通过内置的公钥证书的公钥内容对比server返回的公钥，即可验证server的身份。
